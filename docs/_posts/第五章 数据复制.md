# 第五章 数据复制
复制的目的：
 - 使数据在地理位置上更接近用户，从而降低访问延迟。
 - 当部分组件出现故障时，系统依然可以工作，提高可用性。
 - 扩展至多台机器，同时提供数据访问服务，从而提高读吞吐量。

常见的数据复制方法：
 - 主从复制
 - 多主节点复制
 - 无主节点复制
 
## 主从复制
### 主从复制的原理
> 一个主节点，多个从节点。
> 只有主节点可以写入，从节点都是只读的。

客户端--> 写入到主节点 --> 主节点落盘 --> 把数据同步到从节点--> 从节点写入数据（严格保持和主节点相同的写入顺序）。
### 同步复制 vs 异步复制
首先，这是一个非常重要的设计选项，OLTP 系统一般都会将其作为一个可配置的选项。
同步复制的优点：一旦向用户确认，主从节点的数据肯定是一致的，也就是说从节点的数据肯定是最新的数据。主节点如果故障，可以从从节点获取最新的数据，主从切换，也不存在数据丢失的问题。
同步复制的缺点：如果从节点无法完成确认（网络原因或者其他原因导致），那么主节点会会阻塞后续所有的写操作，直到同步的从节点确认完成。
异步复制的优点：系统写吞吐性能好。
异步复制的缺点：数据一致性无法保证。

**通常采用的做法**
半同步
在一主多从的配置中，保证至少两个节点拥有最新的数据（一个主节点和一个从节点）。
当同步的从节点变得不可用或者性能下降时，从异步复制的从节点中选择一个从节点作为同步的从节点，之前的同步的从节点摘掉或者变成异步的从节点。
“从异步复制的从节点中选择一个从节点作为同步的从节点” 具体怎么选择？

**prob:如何检测从节点是否可用？或者性能下降？**

### 异步复制，怎么尽量保证数据的一致性？
链式复制算法

### 怎样在不停机的情况下添加新的从节点？
step1: 定期对主节点的数据生成快照，这样避免长时间锁定数据库。
step2: 拷贝快照数据到从节点。
step3: 从节点连接到主节点，并请求快照点之后所发生的数据更改日志。**快照和系统的复制日志之间如何关联的？GTID**
step4: 获得日志后，从节点来应用这些快照点之后所有数据变更，这个过程称为追赶。
### 如何处理从节点失效？
追赶式恢复
要能够做到追赶式恢复，需要保证主从节点的复制日志的格式是一致的。
当从节点从故障中恢复后，可以利用本地的复制日志的偏移量，连接到主节点，并请求本地复制日志的偏移量之后的所有数据。（以GTID为例，如果GTID不是严格有序的话，就要保证两个日志文件的数据顺序严格一致）。问题：
 - GTID 是严格有序的吗？
 - 如果不是，主从的日志文件是怎么保证严格一致的？
 - 从节点的日志写入流程？

### 如何处理主节点失效？ 
阿里云 三节点 金融版 实现：https://slideplayer.com/slide/14273652/
切换的过程：
 - 选择某个从节点将其提升为主节点。（选择的标准是什么？MySQL 和 Redis 具体是如何选择的？）
 - 客户端更新主节点的地址
 - 从节点要接受来自新主节点上的变更数据
#### 自动切换过程
 - 确认主节点失效。
     - 基于超时的机制，心跳信息，节点间频繁的互相发送心跳存活消息。
 - 选举新的主节点
     - 通过选举的方式。共识问题。
 - 重新配置系统，使新的主节点生效。
     - 
####  脑裂问题？

### 主从复制存在的问题
 - 主从延迟
 - 同步复制 vs 异步复制
 - 